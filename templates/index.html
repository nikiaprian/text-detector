<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ekstrak Teks Biru dari PDF</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      color: #1a1a1a;
    }
    .container-form {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem 1rem;
    }
    h1 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: #0d47a1;
    }
    p {
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    form {
      border: 2px dashed #90caf9;
      border-radius: 8px;
      padding: 2rem;
      background: #e3f2fd;
      margin-bottom: 1rem;
    }
    input[type="file"] {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover { background: #1565c0; }
    button:disabled {
      background: #90a4ae;
      cursor: not-allowed;
    }
    #loading {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      background: #e3f2fd;
      color: #1565c0;
      font-size: 0.9rem;
      display: none;
      align-items: center;
      gap: 0.75rem;
    }
    #loading.tampil { display: flex; }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #90caf9;
      border-top-color: #1976d2;
      border-radius: 50%;
      animation: putar 0.8s linear infinite;
    }
    @keyframes putar {
      to { transform: rotate(360deg); }
    }
    #pesan {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: none;
    }
    #pesan.error { background: #ffebee; color: #c62828; display: block; }
    #pesan.sukses { background: #e8f5e9; color: #2e7d32; display: block; }
    .hasil-wrapper {
      margin-top: 2rem;
      width: 100%;
      padding: 0 1.5rem;
      margin-left: 0.5rem;
      margin-right: 0.5rem;
      box-sizing: border-box;
      max-width: calc(100vw - 2rem);
    }
    .hasil-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      padding: 0;
    }
    .hasil-header h2 {
      font-size: 1.1rem;
      color: #0d47a1;
      margin: 0;
    }
    #btn-download-pdf {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    #btn-download-pdf:hover { background: #1b5e20; }
    .scroll-hint {
      font-size: 0.8rem;
      color: #666;
      margin: 0 0 4px 0;
    }
    /* Scroll horizontal di atas: agar user bisa geser tabel tanpa scroll ke bawah dulu */
    .tabel-scroll-top {
      overflow-x: auto;
      overflow-y: hidden;
      border: 1px solid #90caf9;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      background: #e3f2fd;
      min-height: 28px;
      padding: 8px 0;
      -webkit-overflow-scrolling: touch;
    }
    .tabel-scroll-top .tabel-scroll-spacer {
      height: 1px;
      display: block;
    }
    .tabel-scroll-top::-webkit-scrollbar {
      height: 14px;
    }
    .tabel-scroll-top::-webkit-scrollbar-track {
      background: #bbdefb;
      border-radius: 4px;
    }
    .tabel-scroll-top::-webkit-scrollbar-thumb {
      background: #1976d2;
      border-radius: 4px;
    }
    .tabel-scroll-top::-webkit-scrollbar-thumb:hover {
      background: #1565c0;
    }
    .tabel-scroll {
      overflow-x: auto;
      border: 1px solid #90caf9;
      border-radius: 0 0 8px 8px;
      background: #fff;
      -webkit-overflow-scrolling: touch;
    }
    .tabel-hasil {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    .tabel-hasil th,
    .tabel-hasil td {
      border: 1px solid #90caf9;
      padding: 0.5rem 0.75rem;
      text-align: left;
      color: #0d47a1;
      word-wrap: break-word;
      vertical-align: top;
    }
    .tabel-hasil th {
      background: #e3f2fd;
      font-weight: 600;
    }
    .tabel-hasil tr:nth-child(even) { background: #f5f9ff; }
  </style>
</head>
<body>
  <div class="container-form">
  <h1>Ekstrak Teks Biru dari PDF</h1>
  <p>Unggah file PDF. Hanya teks yang berwarna biru akan dibaca dan ditampilkan sebagai tabel di bawah. Anda bisa mengunduh hasilnya sebagai PDF.</p>

  <form id="form" enctype="multipart/form-data">
    <label for="file">Pilih file PDF</label>
    <input type="file" id="file" name="file" accept=".pdf" required>
    <button type="submit" id="btn">Ekstrak teks biru</button>
  </form>

  <div id="loading" aria-live="polite">
    <span class="spinner" aria-hidden="true"></span>
    <span>Memproses PDFâ€¦</span>
  </div>
  <div id="pesan" role="alert"></div>
  </div>

  <div id="hasil-wrapper" class="hasil-wrapper" style="display: none;">
    <div class="hasil-header">
      <h2>Hasil</h2>
      <button type="button" id="btn-download-pdf">Unduh PDF</button>
    </div>
    <p class="scroll-hint">Geser tabel ke kiri/kanan di sini (tanpa perlu scroll ke bawah):</p>
    <div id="tabel-scroll-top" class="tabel-scroll-top" aria-hidden="true">
      <span id="tabel-scroll-spacer" class="tabel-scroll-spacer"></span>
    </div>
    <div id="tabel-scroll" class="tabel-scroll">
      <table id="tabel-hasil" class="tabel-hasil"></table>
    </div>
  </div>

  <script>
    const form = document.getElementById("form");
    const fileInput = document.getElementById("file");
    const btn = document.getElementById("btn");
    const loading = document.getElementById("loading");
    const pesan = document.getElementById("pesan");
    const hasilWrapper = document.getElementById("hasil-wrapper");
    const tabelHasil = document.getElementById("tabel-hasil");
    const tabelScroll = document.getElementById("tabel-scroll");
    const tabelScrollTop = document.getElementById("tabel-scroll-top");
    const tabelScrollSpacer = document.getElementById("tabel-scroll-spacer");
    const btnDownloadPdf = document.getElementById("btn-download-pdf");

    let dataTabelTerakhir = [];

    function syncScrollAtas() {
      tabelScroll.scrollLeft = tabelScrollTop.scrollLeft;
    }
    function syncScrollBawah() {
      tabelScrollTop.scrollLeft = tabelScroll.scrollLeft;
    }
    function pasangSyncScroll() {
      tabelScrollTop.removeEventListener("scroll", syncScrollAtas);
      tabelScroll.removeEventListener("scroll", syncScrollBawah);
      tabelScrollTop.addEventListener("scroll", syncScrollAtas);
      tabelScroll.addEventListener("scroll", syncScrollBawah);
    }

    function tampilPesan(teks, isError) {
      pesan.textContent = teks;
      pesan.className = isError ? "error" : "sukses";
      pesan.style.display = "block";
    }

    function tampilLoading(show) {
      loading.classList.toggle("tampil", show);
      if (!show) pesan.style.display = "none";
    }

    function renderTabel(table, headerTop) {
      dataTabelTerakhir = table || [];
      tabelHasil.innerHTML = "";
      if (!table || table.length === 0) {
        hasilWrapper.style.display = "none";
        return;
      }
      const numCols = Math.max(...table.map(r => r.length));
      const thead = document.createElement("thead");
      const headerRow = table[0] || [];
      // Baris header atas (Kepemilikan Per 28-JAN-2026, 29-JAN-2026, dll) dengan colspan
      if (headerTop && headerTop.length > 0) {
        const trTop = document.createElement("tr");
        headerTop.forEach(function (cell) {
          const th = document.createElement("th");
          th.textContent = cell.text || "";
          th.setAttribute("colspan", String(cell.colspan || 1));
          trTop.appendChild(th);
        });
        thead.appendChild(trTop);
      }
      // Baris header utama (No, Kode Efek, Nama Emiten, ...)
      const trHead = document.createElement("tr");
      for (let c = 0; c < numCols; c++) {
        const th = document.createElement("th");
        th.textContent = headerRow.length > c ? (headerRow[c] || "") : "";
        trHead.appendChild(th);
      }
      thead.appendChild(trHead);
      tabelHasil.appendChild(thead);
      const tbody = document.createElement("tbody");
      for (let i = 1; i < table.length; i++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < numCols; c++) {
          const td = document.createElement("td");
          td.textContent = table[i].length > c ? (table[i][c] || "") : "";
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tabelHasil.appendChild(tbody);
      hasilWrapper.style.display = "block";
      requestAnimationFrame(function () {
        const w = tabelHasil.scrollWidth;
        tabelScrollSpacer.style.width = w + "px";
        tabelScrollTop.scrollLeft = 0;
        tabelScroll.scrollLeft = 0;
        pasangSyncScroll();
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) {
        tampilPesan("Pilih file PDF terlebih dahulu.", true);
        return;
      }
      btn.disabled = true;
      tampilLoading(true);
      hasilWrapper.style.display = "none";
      const fd = new FormData();
      fd.append("file", file);
      try {
        const res = await fetch("/api/extract-blue", {
          method: "POST",
          body: fd,
        });
        tampilLoading(false);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data.error || res.statusText;
          const hint = data.hint ? " " + data.hint : "";
          tampilPesan(msg + hint, true);
          return;
        }
        if (data.table && data.table.length > 0) {
          renderTabel(data.table, data.header_top || null);
          tampilPesan("Teks biru berhasil diekstrak. Tabel ditampilkan di bawah.", false);
        } else {
          tampilPesan("Tidak ada data tabel.", true);
        }
      } catch (err) {
        tampilLoading(false);
        tampilPesan("Gagal: " + err.message, true);
      } finally {
        btn.disabled = false;
      }
    });

    btnDownloadPdf.addEventListener("click", async () => {
      if (dataTabelTerakhir.length === 0) {
        tampilPesan("Belum ada data tabel. Ekstrak PDF terlebih dahulu.", true);
        return;
      }
      btnDownloadPdf.disabled = true;
      try {
        const res = await fetch("/api/download-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ table: dataTabelTerakhir }),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          tampilPesan(data.error || "Gagal membuat PDF", true);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "teks_biru_tabel.pdf";
        a.click();
        URL.revokeObjectURL(url);
        tampilPesan("PDF berhasil diunduh.", false);
      } catch (err) {
        tampilPesan("Gagal: " + err.message, true);
      } finally {
        btnDownloadPdf.disabled = false;
      }
    });
  </script>
</body>
</html>
