<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ekstrak Teks Biru dari PDF</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      color: #1a1a1a;
    }
    .container-form {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem 1rem;
    }
    h1 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: #0d47a1;
    }
    p {
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    form {
      border: 2px dashed #90caf9;
      border-radius: 8px;
      padding: 2rem;
      background: #e3f2fd;
      margin-bottom: 1rem;
    }
    input[type="file"] {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover { background: #1565c0; }
    button:disabled {
      background: #90a4ae;
      cursor: not-allowed;
    }
    #loading {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      background: #e3f2fd;
      color: #1565c0;
      font-size: 0.9rem;
      display: none;
      align-items: center;
      gap: 0.75rem;
    }
    #loading.tampil { display: flex; }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #90caf9;
      border-top-color: #1976d2;
      border-radius: 50%;
      animation: putar 0.8s linear infinite;
    }
    @keyframes putar {
      to { transform: rotate(360deg); }
    }
    #pesan {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: none;
    }
    #pesan.error { background: #ffebee; color: #c62828; display: block; }
    #pesan.sukses { background: #e8f5e9; color: #2e7d32; display: block; }
    .hasil-wrapper {
      margin-top: 2rem;
      width: 100%;
      padding: 0 1.5rem;
      margin-left: 1rem;
      margin-right: 1rem;
      box-sizing: border-box;
      max-width: calc(100% - 2rem);
    }
    .hasil-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      padding: 0;
    }
    .hasil-header h2 {
      font-size: 1.25rem;
      color: #1565c0;
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.3px;
    }
    #btn-download-pdf {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    #btn-download-pdf:hover {
      background: #1b5e20;
      box-shadow: 0 3px 6px rgba(46, 125, 50, 0.3);
      transform: translateY(-1px);
    }
    .kolom-filter-wrap {
      position: relative;
      display: inline-block;
    }
    #btn-filter-kolom {
      background: #5c6bc0;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(92, 107, 192, 0.2);
    }
    #btn-filter-kolom:hover {
      background: #3949ab;
      box-shadow: 0 3px 6px rgba(92, 107, 192, 0.3);
      transform: translateY(-1px);
    }
    .filter-icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      fill: currentColor;
    }
    .kolom-filter-panel {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15), 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem 1.25rem;
      min-width: 300px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
    }
    .kolom-filter-panel::-webkit-scrollbar {
      width: 8px;
    }
    .kolom-filter-panel::-webkit-scrollbar-thumb {
      background: #90caf9;
      border-radius: 4px;
    }
    .kolom-filter-panel.tampil { display: block; }
    .kolom-filter-panel h3 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      color: #1565c0;
      font-weight: 600;
      border-bottom: 2px solid #e3f2fd;
      padding-bottom: 0.5rem;
    }
    .kolom-filter-panel .filter-actions {
      margin-bottom: 0.75rem;
      display: flex;
      gap: 0.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #f0f0f0;
    }
    .kolom-filter-panel .filter-actions button {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #90caf9;
      border-radius: 5px;
      transition: all 0.2s ease;
    }
    .kolom-filter-panel .filter-actions button:hover {
      background: #bbdefb;
      border-color: #64b5f6;
      transform: translateY(-1px);
    }
    .kolom-filter-panel label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0.5rem;
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.15s ease;
    }
    .kolom-filter-panel label:hover {
      background: #f5f9ff;
    }
    .kolom-filter-panel input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: #5c6bc0;
    }
    .tabel-hasil th.col-visibility-hidden,
    .tabel-hasil td.col-visibility-hidden { display: none !important; }
    /* Area scroll horizontal di atas tabel: selalu terlihat, tidak perlu scroll ke bawah */
    .tabel-scroll-label {
      font-size: 0.8rem;
      color: #1565c0;
      margin-bottom: 0.35rem;
      display: block;
    }
    .tabel-scroll-top {
      overflow-x: auto;
      overflow-y: hidden;
      border: 1px solid #e0e0e0;
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      background: #f5f9ff;
      min-height: 28px;
      padding: 4px 0;
      -webkit-overflow-scrolling: touch;
    }
    .tabel-scroll-top::-webkit-scrollbar,
    .tabel-scroll::-webkit-scrollbar {
      height: 12px;
    }
    .tabel-scroll-top::-webkit-scrollbar-thumb,
    .tabel-scroll::-webkit-scrollbar-thumb {
      background: #90caf9;
      border-radius: 6px;
    }
    .tabel-scroll-top .tabel-scroll-spacer {
      height: 1px;
      display: block;
    }
    .tabel-scroll {
      overflow-x: auto;
      border: 1px solid #e0e0e0;
      border-radius: 0 0 10px 10px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      -webkit-overflow-scrolling: touch;
    }
    .tabel-hasil {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.875rem;
      background: #fff;
    }
    .tabel-hasil th,
    .tabel-hasil td {
      border: 1px solid #e0e0e0;
      padding: 0.75rem 1rem;
      text-align: left;
      word-wrap: break-word;
      vertical-align: top;
      transition: background-color 0.15s ease;
    }
    .tabel-hasil th {
      background: linear-gradient(180deg, #f5f9ff 0%, #e3f2fd 100%);
      font-weight: 600;
      color: #1565c0;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 2px solid #90caf9;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
      text-align: center;
      vertical-align: middle;
    }
    .tabel-hasil th:first-child {
      border-left: none;
    }
    .tabel-hasil th:last-child {
      border-right: none;
    }
    /* Baris header atas (Kepemilikan Per 28-JAN-2026, dll) seperti di PDF */
    .tabel-hasil thead tr:first-child th {
      background: linear-gradient(180deg, #c62828 0%, #b71c1c 100%);
      color: #fff;
      font-weight: 600;
      border-color: #8b0000;
      border-bottom: 2px solid #8b0000;
      text-transform: none;
      letter-spacing: normal;
      text-align: center;
      vertical-align: middle;
    }
    .tabel-hasil tbody tr {
      transition: background-color 0.15s ease, transform 0.1s ease;
    }
    /* Kolom merge: rata tengah kiri-kanan dan atas-bawah */
    .tabel-hasil td.cell-merge {
      text-align: center;
      vertical-align: middle;
    }
    .tabel-hasil tbody tr:nth-child(even) {
      background: #fafbfd;
    }
    .tabel-hasil tbody tr:nth-child(odd) {
      background: #ffffff;
    }
    .tabel-hasil tbody tr:hover {
      background: #e8f0f8;
      transform: scale(1.001);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .tabel-hasil td {
      color: #424242;
      border-color: #e8e8e8;
    }
    .tabel-hasil tbody tr:first-child td {
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container-form">
  <h1>Ekstrak Teks Biru dari PDF</h1>
  <p>Unggah file PDF. Hanya teks yang berwarna biru akan dibaca dan ditampilkan sebagai tabel di bawah. Anda bisa mengunduh hasilnya sebagai PDF.</p>

  <form id="form" enctype="multipart/form-data">
    <label for="file">Pilih file PDF</label>
    <input type="file" id="file" name="file" accept=".pdf" required>
    <button type="submit" id="btn">Ekstrak teks biru</button>
  </form>

  <div id="loading" aria-live="polite">
    <span class="spinner" aria-hidden="true"></span>
    <span>Memproses PDF…</span>
  </div>
  <div id="pesan" role="alert"></div>
  </div>

  <div id="hasil-wrapper" class="hasil-wrapper" style="display: none;">
    <div class="hasil-header">
      <h2>Hasil</h2>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div class="kolom-filter-wrap">
          <button type="button" id="btn-filter-kolom">
            <svg class="filter-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
            </svg>
            Filter kolom
          </button>
          <div id="kolom-filter-panel" class="kolom-filter-panel" aria-label="Pilih kolom yang ditampilkan">
            <h3>Kolom yang ditampilkan</h3>
            <div class="filter-actions">
              <button type="button" id="btn-tampilkan-semua">Tampilkan semua</button>
              <button type="button" id="btn-sembunyikan-semua">Sembunyikan semua</button>
            </div>
            <div id="kolom-filter-list"></div>
          </div>
        </div>
        <button type="button" id="btn-download-raw">Unduh Raw Data</button>
        <button type="button" id="btn-download-pdf">Unduh PDF</button>
      </div>
    </div>
    <span class="tabel-scroll-label" id="tabel-scroll-label">Geser tabel ← / →</span>
    <div id="tabel-scroll-top" class="tabel-scroll-top" aria-label="Scroll horizontal tabel">
      <span id="tabel-scroll-spacer" class="tabel-scroll-spacer"></span>
    </div>
    <div id="tabel-scroll" class="tabel-scroll">
      <table id="tabel-hasil" class="tabel-hasil"></table>
    </div>
  </div>

  <script>
    const form = document.getElementById("form");
    const fileInput = document.getElementById("file");
    const btn = document.getElementById("btn");
    const loading = document.getElementById("loading");
    const pesan = document.getElementById("pesan");
    const hasilWrapper = document.getElementById("hasil-wrapper");
    const tabelHasil = document.getElementById("tabel-hasil");
    const tabelScroll = document.getElementById("tabel-scroll");
    const tabelScrollTop = document.getElementById("tabel-scroll-top");
    const tabelScrollSpacer = document.getElementById("tabel-scroll-spacer");
    const btnDownloadRaw = document.getElementById("btn-download-raw");
    const btnDownloadPdf = document.getElementById("btn-download-pdf");
    const btnFilterKolom = document.getElementById("btn-filter-kolom");
    const kolomFilterPanel = document.getElementById("kolom-filter-panel");
    const kolomFilterList = document.getElementById("kolom-filter-list");
    const btnTampilkanSemua = document.getElementById("btn-tampilkan-semua");
    const btnSembunyikanSemua = document.getElementById("btn-sembunyikan-semua");

    let dataTabelTerakhir = [];
    let rawDataTerakhir = []; // data mentah untuk debugging (sebelum koreksi)
    let rawBlueLinesTerakhir = []; // semua teks biru, satu kata per baris (untuk Unduh Raw Data PDF)
    let colVisibility = []; // true = tampilkan, false = sembunyikan

    function syncScrollAtas() {
      tabelScroll.scrollLeft = tabelScrollTop.scrollLeft;
    }
    function syncScrollBawah() {
      tabelScrollTop.scrollLeft = tabelScroll.scrollLeft;
    }
    function pasangSyncScroll() {
      tabelScrollTop.removeEventListener("scroll", syncScrollAtas);
      tabelScroll.removeEventListener("scroll", syncScrollBawah);
      tabelScrollTop.addEventListener("scroll", syncScrollAtas);
      tabelScroll.addEventListener("scroll", syncScrollBawah);
    }

    function tampilPesan(teks, isError) {
      pesan.textContent = teks;
      pesan.className = isError ? "error" : "sukses";
      pesan.style.display = "block";
    }

    function tampilLoading(show) {
      loading.classList.toggle("tampil", show);
      if (!show) pesan.style.display = "none";
    }

    function applyColumnVisibility() {
      const numCols = colVisibility.length;
      for (let c = 0; c < numCols; c++) {
        const visible = colVisibility[c] !== false;
        const cls = visible ? "col-visibility-visible" : "col-visibility-hidden";
        tabelHasil.querySelectorAll("th[data-col=\"" + c + "\"], td[data-col=\"" + c + "\"]").forEach(function (el) {
          el.classList.remove("col-visibility-visible", "col-visibility-hidden");
          el.classList.add(cls);
        });
      }
      kolomFilterList.querySelectorAll("input[type=checkbox]").forEach(function (cb, i) {
        if (colVisibility[i] !== undefined) cb.checked = colVisibility[i];
      });
    }

    const KOLOM_TABEL_STANDAR = 17;
    function renderTabel(table, headerTop) {
      dataTabelTerakhir = table || [];
      tabelHasil.innerHTML = "";
      if (!table || table.length === 0) {
        hasilWrapper.style.display = "none";
        kolomFilterList.innerHTML = "";
        return;
      }
      const maxLen = Math.max(...table.map(r => (r && r.length) ? r.length : 0));
      const numCols = Math.max(KOLOM_TABEL_STANDAR, maxLen);
      const headerRow = (table[0] || []);
      const headerPadded = headerRow.slice(0, numCols);
      while (headerPadded.length < numCols) headerPadded.push("Kolom " + (headerPadded.length + 1));
      colVisibility = Array(numCols).fill(true);
      
      // Kolom yang defaultnya disembunyikan: Alamat, Alamat (Lanjutan), Kebangsaan, Domisili
      const kolomDefaultHidden = ["Alamat", "Alamat (Lanjutan)", "Kebangsaan", "Domisili"];
      for (let c = 0; c < numCols; c++) {
        const headerName = (headerPadded[c] || "").trim();
        if (kolomDefaultHidden.includes(headerName)) {
          colVisibility[c] = false;
        }
      }

      const thead = document.createElement("thead");
      if (headerTop && headerTop.length > 0) {
        const trTop = document.createElement("tr");
        headerTop.forEach(function (cell) {
          const th = document.createElement("th");
          th.textContent = cell.text || "";
          th.setAttribute("colspan", String(cell.colspan || 1));
          trTop.appendChild(th);
        });
        thead.appendChild(trTop);
      }
      const trHead = document.createElement("tr");
      for (let c = 0; c < numCols; c++) {
        const th = document.createElement("th");
        th.setAttribute("data-col", String(c));
        const visible = colVisibility[c] !== false;
        th.classList.add(visible ? "col-visibility-visible" : "col-visibility-hidden");
        th.textContent = headerPadded[c] || ("Kolom " + (c + 1));
        trHead.appendChild(th);
      }
      thead.appendChild(trHead);
      tabelHasil.appendChild(thead);
      // Kolom yang di-merge untuk entri multi-baris (No, Nama Emiten, Nama Pemegang Saham, Saham Gabungan, Persentase)
      const mergeKeywords = [
        "No",
        "Nama Emiten",
        "Nama Pemegang Saham",
        "Saham Gabungan Per Investor (1)",
        "Saham Gabungan Per Investor (2)",
        "Persentase Kepemilikan Per Investor"
      ];
      const mergeCols = [];
      for (let c = 0; c < numCols; c++) {
        const h = (headerPadded[c] || "").trim();
        if (mergeKeywords.some(function (kw) { return h === kw || h.indexOf(kw) >= 0; })) {
          mergeCols.push(c);
        }
      }

      // Deteksi grup baris: No sama atau baris lanjutan (No "-") dengan Kode Efek sama = satu grup
      const dataRows = [];
      for (let i = 1; i < table.length; i++) {
        dataRows.push(table[i] || []);
      }
      const groupInfo = [];
      let groupStart = 0;
      const isNumericNo = function (s) {
        const t = (s || "").toString().trim();
        return /^\d+$/.test(t);
      };
      let lastNumericNo = null;
      let lastKode = "";
      for (let r = 0; r < dataRows.length; r++) {
        const row = dataRows[r];
        const no = (row[0] || "").toString().trim();
        const kode = (row[1] || "").toString().trim();
        const prevNo = r > 0 ? (dataRows[r - 1][0] || "").toString().trim() : "";
        const prevKode = r > 0 ? (dataRows[r - 1][1] || "").toString().trim() : "";
        let isBreak = false;
        if (r > 0) {
          if (isNumericNo(no) && lastNumericNo !== null && no !== lastNumericNo) {
            if (!(prevNo === "-" && kode && kode === prevKode)) {
              isBreak = true;
            }
          } else if (no === "-" && kode && prevKode && kode !== prevKode) {
            isBreak = true;
          }
        }
        if (isNumericNo(no)) lastNumericNo = no;
        if (kode) lastKode = kode;
        if (isBreak) {
          groupInfo.push({ size: r - groupStart, firstRowIdx: groupStart });
          groupStart = r;
        }
      }
      if (dataRows.length > 0) {
        groupInfo.push({ size: dataRows.length - groupStart, firstRowIdx: groupStart });
      }

      const rowToGroup = [];
      for (let g = 0; g < groupInfo.length; g++) {
        const info = groupInfo[g];
        for (let k = 0; k < info.size; k++) {
          rowToGroup[info.firstRowIdx + k] = info;
        }
      }

      const tbody = document.createElement("tbody");
      const rowSpanRemaining = {};
      for (let c = 0; c < numCols; c++) rowSpanRemaining[c] = 0;

      for (let i = 0; i < dataRows.length; i++) {
        const tr = document.createElement("tr");
        const row = dataRows[i];
        const rowPadded = row.slice(0, numCols);
        while (rowPadded.length < numCols) rowPadded.push("-");
        const info = rowToGroup[i] || { size: 1, firstRowIdx: i };

        for (let c = 0; c < numCols; c++) {
          if (rowSpanRemaining[c] > 0) {
            rowSpanRemaining[c]--;
            continue;
          }
          const td = document.createElement("td");
          td.setAttribute("data-col", String(c));
          const visible = colVisibility[c] !== false;
          td.classList.add(visible ? "col-visibility-visible" : "col-visibility-hidden");

          const isMergeCol = mergeCols.indexOf(c) >= 0;
          const isFirstInGroup = (info.firstRowIdx === i);
          const shouldMerge = isMergeCol && isFirstInGroup && info.size > 1;

          if (shouldMerge) {
            td.classList.add("cell-merge");
            td.setAttribute("rowspan", String(info.size));
            rowSpanRemaining[c] = info.size - 1;
            // Ambil nilai terbaik dari grup: No prefer numerik, Nama Emiten prefer yang lengkap (Tbk/PT)
            let val = rowPadded[c];
            const vals = [];
            for (let k = 0; k < info.size; k++) {
              const rk = dataRows[info.firstRowIdx + k] || [];
              const v = (rk[c] || "").toString().trim();
              if (v && v !== "-") vals.push(v);
            }
            if (vals.length > 0) {
              if (c === 0) {
                val = vals.find(function (v) { return /^\d+$/.test(v); }) || vals[0];
              } else if (c === 2) {
                const withTbk = vals.filter(function (v) { return v.indexOf("Tbk") >= 0 || v.indexOf("PT") >= 0; });
                val = withTbk.length > 0
                  ? withTbk.reduce(function (a, b) { return a.length >= b.length ? a : b; })
                  : vals[0];
              } else {
                val = vals[0];
              }
            }
            td.textContent = (val !== undefined && val !== "" && val !== "-") ? val : "-";
          } else {
            td.textContent = rowPadded[c] !== undefined && rowPadded[c] !== "" ? rowPadded[c] : "-";
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tabelHasil.appendChild(tbody);

      kolomFilterList.innerHTML = "";
      for (let c = 0; c < numCols; c++) {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = colVisibility[c] !== false;
        cb.setAttribute("data-col", String(c));
        cb.addEventListener("change", function () {
          colVisibility[c] = cb.checked;
          applyColumnVisibility();
        });
        label.appendChild(cb);
        label.appendChild(document.createTextNode(headerPadded[c] || ("Kolom " + (c + 1))));
        kolomFilterList.appendChild(label);
      }

      hasilWrapper.style.display = "block";
      requestAnimationFrame(function () {
        const w = tabelHasil.scrollWidth;
        tabelScrollSpacer.style.width = w + "px";
        tabelScrollTop.scrollLeft = 0;
        tabelScroll.scrollLeft = 0;
        pasangSyncScroll();
      });
    }

    btnFilterKolom.addEventListener("click", function (e) {
      e.stopPropagation();
      kolomFilterPanel.classList.toggle("tampil");
    });
    document.addEventListener("click", function () {
      kolomFilterPanel.classList.remove("tampil");
    });
    kolomFilterPanel.addEventListener("click", function (e) {
      e.stopPropagation();
    });
    btnTampilkanSemua.addEventListener("click", function () {
      for (let i = 0; i < colVisibility.length; i++) colVisibility[i] = true;
      applyColumnVisibility();
    });
    btnSembunyikanSemua.addEventListener("click", function () {
      for (let i = 0; i < colVisibility.length; i++) colVisibility[i] = false;
      applyColumnVisibility();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) {
        tampilPesan("Pilih file PDF terlebih dahulu.", true);
        return;
      }
      btn.disabled = true;
      tampilLoading(true);
      hasilWrapper.style.display = "none";
      const fd = new FormData();
      fd.append("file", file);
      try {
        const res = await fetch("/api/extract-blue", {
          method: "POST",
          body: fd,
        });
        tampilLoading(false);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data.error || res.statusText;
          const hint = data.hint ? " " + data.hint : "";
          tampilPesan(msg + hint, true);
          return;
        }
        if (data.table && data.table.length > 0) {
          rawDataTerakhir = data.raw_data || [];
          rawBlueLinesTerakhir = data.raw_blue_lines || [];
          if (data.debug_707) console.log("[Debug Backend] debug_707:", data.debug_707);
          const rows707 = [];
          for (let i = 1; i < data.table.length; i++) {
            const row = data.table[i] || [];
            const no = (row[0] || "").toString().trim();
            const prevNo = i > 1 ? (data.table[i - 1][0] || "").toString().trim() : "";
            if (no === "707" || (prevNo === "707" && !no)) rows707.push({ index: i, no: no || "(lanjutan)", row: row.slice(0, 18) });
          }
          if (rows707.length) console.log("[Debug Backend] Baris No 707 dari backend:", rows707);
          renderTabel(data.table, data.header_top || null);
          tampilPesan("Teks biru berhasil diekstrak. Tabel ditampilkan di bawah.", false);
        } else {
          tampilPesan("Tidak ada data tabel.", true);
        }
      } catch (err) {
        tampilLoading(false);
        tampilPesan("Gagal: " + err.message, true);
      } finally {
        btn.disabled = false;
      }
    });

    btnDownloadRaw.addEventListener("click", async () => {
      if (!rawBlueLinesTerakhir || rawBlueLinesTerakhir.length === 0) {
        tampilPesan("Belum ada raw teks biru. Ekstrak PDF terlebih dahulu.", true);
        return;
      }
      btnDownloadRaw.disabled = true;
      try {
        const res = await fetch("/api/download-raw-blue-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lines: rawBlueLinesTerakhir }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          tampilPesan(err.error || "Gagal membuat PDF raw", true);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "raw_teks_biru_satu_baris.pdf";
        a.click();
        URL.revokeObjectURL(url);
        tampilPesan("PDF raw teks biru (satu kata per baris) berhasil diunduh.", false);
      } catch (err) {
        tampilPesan("Gagal: " + err.message, true);
      } finally {
        btnDownloadRaw.disabled = false;
      }
    });

    btnDownloadPdf.addEventListener("click", async () => {
      if (dataTabelTerakhir.length === 0) {
        tampilPesan("Belum ada data tabel. Ekstrak PDF terlebih dahulu.", true);
        return;
      }
      btnDownloadPdf.disabled = true;
      try {
        const res = await fetch("/api/download-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ table: dataTabelTerakhir }),
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          tampilPesan(data.error || "Gagal membuat PDF", true);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "teks_biru_tabel.pdf";
        a.click();
        URL.revokeObjectURL(url);
        tampilPesan("PDF berhasil diunduh.", false);
      } catch (err) {
        tampilPesan("Gagal: " + err.message, true);
      } finally {
        btnDownloadPdf.disabled = false;
      }
    });
  </script>
</body>
</html>
